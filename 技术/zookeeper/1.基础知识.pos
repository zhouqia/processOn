{"diagram":{"image":{"height":200,"pngdata":"iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsUlEQVR4nO3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8GXHmAAFMgHIEAAAAAElFTkSuQmCC","width":200,"y":0,"x":0},"elements":{"id":"root","structure":"mind_free","leftChildren":[{"id":"409b82cc11e7","title":"cp","children":[],"parent":"root"},{"id":"419ef0102517","title":"解决集群最终一致性问题<br>","parent":"root","children":[{"id":"80ede4043af3","title":"ZAB 协议算法","children":[{"id":"c93dcb38fbeb","title":"崩溃恢复<br>","children":[],"parent":"80ede4043af3"},{"id":"046db9d69c10","title":"原子广播协议","children":[{"id":"fe9bf5679e39","title":"2PC","parent":"046db9d69c10","children":[]}],"parent":"80ede4043af3"}],"parent":"419ef0102517"}]}],"title":"基础知识(版本3.4.14)","root":true,"theme":"theme3","children":[{"id":"b47970444042","title":"a.数据模型","children":[{"id":"7e3680bccebf","title":"1.zk的数据存储在树形结构中","children":[],"parent":"b47970444042"},{"id":"5b6eaa0c5b9f","title":"2.节点类型","children":[{"id":"dc060f838963","title":"持久节点","children":[{"id":"557109745f80","title":"创建客户端与server断开连接，节点仍然存在，需要显式delete","children":[],"parent":"dc060f838963"}],"parent":"5b6eaa0c5b9f"},{"id":"44e3b70949ed","title":"临时节点","children":[{"id":"c4e1e1c45d8f","title":"创建客户端与server断开连接，节点失效","children":[],"parent":"44e3b70949ed"}],"parent":"5b6eaa0c5b9f"},{"id":"3ce36cb67a56","title":"有序节点","children":[{"id":"be710614fb75","title":"“有序”是属性，不是模型，可以修饰持久节点，也可以修饰临时节点","children":[],"parent":"3ce36cb67a56"}],"parent":"5b6eaa0c5b9f"}],"parent":"b47970444042"},{"id":"1a768bb565af","title":"3.数据节点包含的内容","children":[{"id":"79f588f5ffda","title":"存储的数据<br>","parent":"1a768bb565af","children":[]},{"id":"c94c90e287cf","title":"节点本身状态信息","children":[{"id":"58ec2fd1fc06","title":"","image":{"w":388,"url":"http://cdn.processon.com/5fab85956376893d444ec1e4?e=1605079973&amp;token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:Gq5ndYQPE-m0fY6_TPOPMOT7wgI=","h":194},"parent":"c94c90e287cf","children":[{"id":"b068076c531e","title":"节点本身特性的使用","parent":"58ec2fd1fc06","children":[{"id":"dad054e1594f","title":"悲观锁 - 临时节点","parent":"b068076c531e","children":[]},{"id":"ba8852b56c25","title":"乐观锁 - 数据 + 版本号","parent":"b068076c531e","children":[]}]}]}],"parent":"1a768bb565af","collapsed":false}],"parent":"b47970444042","collapsed":false}],"parent":"root","collapsed":false},{"id":"f0203a422dd1","title":"b.日志清除机制","parent":"root","children":[{"id":"ea14e5c09cd0","title":"服务启动后会启动定时清除数据快照和对应的事务日志(删除超过设定值的部分) - 服务启动后立即执行，并默认每小时执行一次<br>","parent":"f0203a422dd1","children":[]}],"collapsed":false},{"id":"b4b00d2ed96e","title":"c.服务端线程模型","parent":"root","children":[{"id":"d0b1f50d8cf1","title":"集群模式","children":[{"id":"2d4b69053805","title":"默认NIO - jdk","parent":"d0b1f50d8cf1","children":[{"id":"8299ce6f4648","title":"selector检测间隔为1秒","children":[],"parent":"2d4b69053805"},{"id":"3f2a841b3980","title":"拆包/粘包方案","summaries":[],"children":[{"id":"3d7f4d64b2ad","title":"读入","children":[{"id":"9cefe044bea2","title":"通过获取数据流长度，进行手动粘包","children":[],"parent":"3d7f4d64b2ad"},{"id":"6044b4c9518b","title":"使用堆内内存 - 填充完整数据(粘包)","children":[],"parent":"3d7f4d64b2ad"},{"id":"bcb3e4fb58f8","title":"非阻塞模式","children":[],"parent":"3d7f4d64b2ad"}],"parent":"3f2a841b3980"},{"id":"5a91c625008b","title":"写出","children":[{"id":"41e0e9a93dc1","title":"使用堆外内存","children":[],"parent":"5a91c625008b"},{"id":"4a042f10ae86","title":"非阻塞模式","children":[],"parent":"5a91c625008b"}],"parent":"3f2a841b3980"}],"parent":"2d4b69053805"},{"id":"544123cc7c7d","title":"selector单线程处理所有事件","style":{"border-radius":"6px","color":"rgb(255, 255, 255)","background-color":"rgb(255, 83, 92)","border-style":"none","border-color":"rgb(255, 255, 255)","border-width":"0px"},"children":[{"id":"59de225e20c2","title":"后续版本加入了work线程池来处理io读写工作","children":[],"parent":"544123cc7c7d"}],"parent":"2d4b69053805"}]},{"id":"cdc6a33901b7","title":"单客户端地址 - 默认最大连接数为60","parent":"d0b1f50d8cf1","children":[]},{"id":"a5fce55b8e80","title":"选举","parent":"d0b1f50d8cf1","children":[{"id":"120aef048ff3","title":"数据模型 - vote","children":[{"id":"6d78b447745a","title":"serverId","children":[],"parent":"120aef048ff3"},{"id":"fcb9d2c0494b","title":"最后记录的事务id","children":[],"parent":"120aef048ff3"},{"id":"5e99dea3ede7","title":"当前的纪元号(currentEpoch)","children":[],"parent":"120aef048ff3"}],"parent":"a5fce55b8e80"},{"id":"9032aef2edcf","title":"算法","children":[{"id":"0028cadb753a","title":"只剩下快速选举法(FastLeaderElection)，其它选举法都已被弃用","children":[{"id":"b4fbc2c3a69b","title":"创建选举时维护tcp连接的管理类","parent":"0028cadb753a","children":[{"id":"4af80f493590","title":"负责 - vote的发送、接收和存储","children":[],"parent":"b4fbc2c3a69b"},{"id":"c71198b83a2d","title":"规则 - sid较大者建立通信","children":[],"parent":"b4fbc2c3a69b"}]},{"id":"8f602e8f7198","title":"对应的监听器","children":[{"id":"c61fb5ea2a4b","title":"负责开启socket的监听","children":[],"parent":"8f602e8f7198"}],"parent":"0028cadb753a"},{"id":"b7463e5647eb","title":"主逻辑 - 选举算法逻辑","parent":"0028cadb753a","children":[{"id":"e44032a99feb","title":"发送 - 投票内容","children":[],"parent":"b7463e5647eb"},{"id":"9dff8b6ffdfe","title":"内部逻辑","parent":"b7463e5647eb","children":[{"id":"064a7680377e","title":"第一次选自己<br>","parent":"9dff8b6ffdfe","children":[]},{"id":"900f6bdb9d49","title":"不断获取从其他节点发送过来的投票信息<br>","summaries":[{"id":"7c26117b50a5","summary":true,"title":"直到超过半数节点投票给同一个节点","style":{"lineType":"curve_complex","lineColor":"#bf1e1b","lineWidth":"1"},"range":"0,2","children":[],"parent":"900f6bdb9d49"}],"parent":"9dff8b6ffdfe","children":[{"id":"5ebd81c825cb","title":"如果投票信息的年代(currentEpoch)比当前节点的年代大，转投该投票信息的节点 - 年代大者胜<br>","children":[],"parent":"900f6bdb9d49"},{"id":"b53a9ef95954","title":"如果投票信息的年代相同则比较最新事务id(zxid) - 事务id大者胜<br>","parent":"900f6bdb9d49","children":[]},{"id":"2c71a5378456","title":"如果年代和事务id都一致，则比较serverId，每个节点的serverId是不同的 - serverId大者胜<br>","parent":"900f6bdb9d49","children":[]}]}]}]}],"parent":"9032aef2edcf"}],"parent":"a5fce55b8e80"}]}],"parent":"b4b00d2ed96e","collapsed":false},{"id":"753893e36e9e","title":"单例模式","children":[{"id":"0fd273246635","title":"默认NIO","parent":"753893e36e9e","children":[{"id":"6c995c79c06e","title":"同集群模式","parent":"0fd273246635","children":[]}],"collapsed":false},{"id":"6ebb0350b61d","title":"单客户端地址 - 默认最大连接数为60","parent":"753893e36e9e","children":[]}],"parent":"b4b00d2ed96e"}],"collapsed":false},{"id":"df31506589aa","title":"d.序列化工具","children":[{"id":"1234acf23c6b","title":"jute","children":[],"parent":"df31506589aa"}],"parent":"root","collapsed":false},{"id":"2ee67d49cf15","title":"e.client与server通讯","children":[{"id":"901b4bd01c98","title":"通讯类 -&nbsp;NIOServerCnxn","parent":"2ee67d49cf15","children":[{"id":"91f890e13747","title":"请求处理链","parent":"901b4bd01c98","children":[{"id":"928277973269","title":"PrepRequestProcessor - 预处理","parent":"91f890e13747","children":[{"id":"3ba0d10aabec","title":"创建各种类型的Request","parent":"928277973269","children":[]},{"id":"de8d41406eb2","title":"针对事务性请求 和 非事务性请求 做对应的处理","parent":"928277973269","children":[]},{"id":"3e4c1b41e065","title":"加入处理链","children":[],"parent":"928277973269"}]},{"id":"8b3dcc0401b1","title":"ProposalRequestProcessor","children":[{"id":"d0c54d15a23d","title":"对事务性的请求操作进行处理<br>","children":[],"parent":"8b3dcc0401b1"},{"id":"8b3c34ea2821","title":"事务性请求转给leader - leader发起投票","parent":"8b3dcc0401b1","children":[]}],"parent":"91f890e13747"},{"id":"9c937001f4c3","title":"SyncRequestProcessor","parent":"91f890e13747","children":[{"id":"ced88255d6c6","title":"对请求持久化 + 打快照","parent":"9c937001f4c3","children":[]}]},{"id":"bca4870c8b5a","title":"CommitProcessor","children":[{"id":"1ee87e4508c0","title":"提交","children":[],"parent":"bca4870c8b5a"}],"parent":"91f890e13747"},{"id":"a273058c21d1","title":"FinalRequestProcessor","parent":"91f890e13747","children":[{"id":"9dcdff9c00a7","title":"返回处理结果","children":[],"parent":"a273058c21d1"}]}],"collapsed":false},{"id":"8e796310bdfc","title":"请求链逻辑","children":[{"id":"92a1cabf257b","title":"事务性请求","children":[{"id":"25d53ca4cda1","title":"当前节点将请求转发给主节点 + 保存请求快照","parent":"92a1cabf257b","children":[]},{"id":"8f36fe13cb96","title":"主节点发起投票 + 多数节点确认即可发起执行命令 - 并返回结果","parent":"92a1cabf257b","children":[]}],"parent":"8e796310bdfc","summaries":[{"summary":true,"id":"fc53e32a4b97","title":"zookeeper缺点 - 当事务性请求过多，leader的压力会非常大","range":"0,1","style":{"lineType":"curve_complex","lineColor":"#bf1e1b","lineWidth":"1"},"parent":"92a1cabf257b","children":[]}]},{"id":"d6d5b6c49f62","title":"非事务性请求","parent":"8e796310bdfc","children":[{"id":"ea05ff8a7531","title":"当前节点直接处理，并返回结果","parent":"d6d5b6c49f62","children":[]}]}],"parent":"901b4bd01c98"}]},{"id":"9ca5348e6cb5","title":"一个服务端 只提供了一个线程处理所有client的所有请求","style":{"border-radius":"6px","color":"rgb(255, 255, 255)","border-style":"none","background-color":"rgb(255, 83, 92)","border-color":"rgb(255, 255, 255)","border-width":"0px"},"parent":"2ee67d49cf15","children":[{"id":"3474896f1e92","title":"后续版本做了优化，增加了work线程池","parent":"9ca5348e6cb5","children":[]}]},{"id":"afa0f010033f","title":"会话","children":[{"id":"2dc34d9dfc4f","title":"核心属性 - 超时时间+会话id","children":[],"parent":"afa0f010033f"},{"id":"43c18a1b8d9b","title":"会话过期","children":[{"id":"cdcd16935309","title":"结构","children":[{"id":"b5ba33ef975d","title":"分桶策略 - 超时时间相近的会话集中存储 - 高效检测","children":[],"parent":"cdcd16935309"}],"parent":"43c18a1b8d9b"},{"id":"4f53a0dbf132","title":"动作","parent":"43c18a1b8d9b","children":[{"id":"60ed35966b6f","title":"通知所有server节点，同时清除该会话对应的临时节点","parent":"4f53a0dbf132","children":[]}]}],"parent":"afa0f010033f"}],"parent":"2ee67d49cf15","collapsed":false}],"parent":"root","collapsed":false},{"id":"2cfe63d8f808","title":"f.watch监控","parent":"root","children":[{"id":"8df66df2530c","title":"watcher事件 - EventTyye","parent":"2cfe63d8f808","children":[{"id":"bafc352bf312","title":"None","parent":"8df66df2530c","children":[]},{"id":"ac6315983581","title":"NodeCreated","parent":"8df66df2530c","children":[]},{"id":"c2e2d5f9c6e2","title":"NodeDeleted","parent":"8df66df2530c","children":[]},{"id":"9baeb0b464c4","title":"NodeDataChanged","parent":"8df66df2530c","children":[]},{"id":"4fbcbe90d5ca","title":"NodeChildrenChanged","parent":"8df66df2530c","children":[]}],"collapsed":false},{"id":"933ff1e1af4d","title":"内部逻辑","children":[{"id":"a279b7636566","title":"客户端注册watcher到服务端","parent":"933ff1e1af4d","children":[]},{"id":"0a374e5724b2","title":"当服务端该数据发生变更时会触发watcher通知","parent":"933ff1e1af4d","children":[]},{"id":"06dd7515be49","title":"服务端通过连接发送消息告知client","parent":"933ff1e1af4d","children":[]},{"id":"a92f32cee03d","title":"客户端回调Watcher处理变更应对逻辑","parent":"933ff1e1af4d","children":[]}],"parent":"2cfe63d8f808","collapsed":false},{"id":"3e4620c08e77","title":"watcher管理者 -&nbsp;WatchManager ","children":[],"parent":"2cfe63d8f808"}],"collapsed":false},{"id":"f7f35eceba8a","title":"g.server之间通讯<br>","parent":"root","children":[{"id":"66bf55741e36","title":"主从之间通信","children":[{"id":"d69c431df08d","title":"从 -&gt; 主","children":[{"id":"1e00d0497a39","title":"following/observe -&nbsp;syncWithLeader<br>","children":[{"id":"feeadb3d417a","title":"根据不同的同步方式进行不同方式的数据同步工作","parent":"1e00d0497a39","children":[]}],"parent":"d69c431df08d"}],"parent":"66bf55741e36"},{"id":"571ebca977be","title":"同步方式","parent":"66bf55741e36","children":[{"id":"f59f266c1899","title":"DIFF<br>","children":[{"id":"47b9431d78da","title":"leader比following有更高版本的数据 - leader向diff发送差异化数据","children":[],"parent":"f59f266c1899"}],"parent":"571ebca977be"},{"id":"544240710fee","title":"TRUNC<br>","parent":"571ebca977be","children":[{"id":"b4344e75a9c3","title":"following比leader有更高版本的数据 - following删除部分数据，保证数据版本和leader保持一致<br>","parent":"544240710fee","children":[]}]},{"id":"833a28073609","title":"TRUNC + DISS<br>","children":[{"id":"bb566067d052","title":"掺杂DIFF 和 TRUNC 两种情况的数据","children":[],"parent":"833a28073609"}],"parent":"571ebca977be"},{"id":"5fd9e8531351","title":"SNAP<br>","parent":"571ebca977be","children":[{"id":"408bf82a8abf","title":"leader全量传输数据给following","children":[],"parent":"5fd9e8531351"}]}],"collapsed":false}],"parent":"f7f35eceba8a"},{"id":"6fe6026c6402","title":"同步","children":[{"id":"65a06f7629c1","title":"事务性如会话会被同步","children":[],"parent":"6fe6026c6402"},{"id":"5bb56d7c7f2c","title":"非事务性如getData不会被同步","children":[],"parent":"6fe6026c6402"}],"parent":"f7f35eceba8a","collapsed":false}]},{"id":"50af388c9064","title":"h.ACL权限控制 - 格式(scheme:id:permission)<br>","parent":"root","children":[{"id":"5d97c0495dff","title":"1.权限模式 -&nbsp;Scheme","children":[{"id":"cfffbc710d07","title":"范围限制 - 限制一段或一个ip","parent":"5d97c0495dff","children":[]},{"id":"6deded42c0fa","title":"口令模式 - 账号密码<br>","parent":"5d97c0495dff","children":[]},{"id":"9da05f314308","title":"免密模式","children":[],"parent":"5d97c0495dff"},{"id":"52e5ee788828","title":"自定义权限控制器","children":[],"parent":"5d97c0495dff"}],"parent":"50af388c9064"},{"id":"f1f198e04554","title":"2.授权对象 -&nbsp;ID","children":[{"id":"d62bdcff48dc","title":"一段或一个ip -&nbsp;范围限制","children":[],"parent":"f1f198e04554"},{"id":"0b130207acd4","title":"用户名 -&nbsp;口令模式","children":[],"parent":"f1f198e04554"},{"id":"312ffc2a68a8","title":"所有的用户 -&nbsp;免密模式","children":[],"parent":"f1f198e04554"}],"parent":"50af388c9064"},{"id":"08ee6377673c","title":"3.权限信息 -&nbsp;Permission","summaries":[{"id":"68e5eae2f296","summary":true,"title":"每个节点都有维护自身的 ACL 权限数据，即使是该节点的子节点也是有自己的 ACL 权限而不是直接继承其父节点的权限","style":{"lineType":"curve_complex","lineColor":"#bf1e1b","lineWidth":"1"},"range":"0,4","children":[],"parent":"08ee6377673c"}],"children":[{"id":"b63bcbc43150","title":"create","children":[{"id":"a017f6dd0eae","title":"增","parent":"b63bcbc43150","children":[]}],"parent":"08ee6377673c"},{"id":"434ece1c1904","title":"delete<br>","children":[{"id":"624e7f10ab24","title":"删","parent":"434ece1c1904","children":[]}],"parent":"08ee6377673c"},{"id":"6756eb327e88","title":"wirte","parent":"08ee6377673c","children":[{"id":"eccfd5f6a1bb","title":"改","parent":"6756eb327e88","children":[]}]},{"id":"411942a19919","title":"read","parent":"08ee6377673c","children":[{"id":"84d94635f1b4","title":"查","parent":"411942a19919","children":[]}]},{"id":"3a173371e850","title":"admin","parent":"08ee6377673c","children":[{"id":"527166d6fdd4","title":"管理员权限","parent":"3a173371e850","children":[]}]}],"parent":"50af388c9064"}],"collapsed":true},{"id":"1f1c93940371","free":true,"title":"对外线程业务的区别","children":[{"id":"a51f1fd3f11c","title":"NIOServerCnxnFactory","children":[{"id":"8c7a8bdce9e5","title":"与客户端进行交互","children":[],"parent":"a51f1fd3f11c"}],"parent":"1f1c93940371"},{"id":"8ae4a745b825","title":"QuorumPeer","children":[{"id":"3cdfd6dc0ebf","title":"server与server进行交互","children":[{"id":"92b7d2a74ec5","title":"选举","parent":"3cdfd6dc0ebf","children":[]},{"id":"e4ff020c9919","title":"leader与fllowing(observing)交互","parent":"3cdfd6dc0ebf","children":[]}],"parent":"8ae4a745b825"}],"parent":"1f1c93940371"}],"parent":"root","pos":{"y":8690.699806213379,"x":10046.000198364258}}]}},"meta":{"id":"5fab79025653bb40e6b4e317","member":"5b8deb14e4b06fc64ae2c0eb","exportTime":"2020-11-18 16:34:28","diagramInfo":{"category":"mind_free","title":"1.基础知识","created":"2020-11-11 13:39:14","creator":"5b8deb14e4b06fc64ae2c0eb","modified":"2020-11-17 16:51:49"},"type":"ProcessOn Schema File","version":"1.0"}}